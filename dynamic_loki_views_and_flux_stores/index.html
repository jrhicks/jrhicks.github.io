<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Wikismith">

    <title>
        Jeffrey Hicks
    </title>

    <!-- bower:css -->
    <link rel="stylesheet" href="/bs3/bower/css/bootstrap.css">
    <!-- endinject -->

    <!-- inject:css -->
    <link rel="stylesheet" href="/bs3/css/blog.css">
    <link rel="stylesheet" href="/bs3/css/docs.min.css">
    <link rel="stylesheet" href="/bs3/css/railscasts.css">
    <!-- endinject -->

    <!--[if lt IE 9]><script src="../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../assets/js/ie10-viewport-bug-workaround.js"></script>
    <script src="../assets/js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Favicons -->
    <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png">
    <link rel="icon" href="/favicon.ico">


</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

<!-- Docs master nav -->
<header class="navbar navbar-static-top bs-docs-nav" id="top" role="banner">
    <div class="container">
        <div class="navbar-header">
            <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <a href="../../../" class="navbar-brand">
              <img src="http://www.gravatar.com/avatar/91f491389b01231140190aef863408c9.png">
              &nbsp;
              jrhicks.github.io
            </a>
        </div>
        <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
            <!--
            <ul class="nav navbar-nav">
                <li>
                    <a href="/interests.html">Interest</a>
                </li>
                <li>
                    <a href="/projects">Projects</a>
                </li>
                <li>
                    <a href="/about">Speaking</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://blog.getbootstrap.com" onclick="ga('send', 'event', 'Navbar', 'Community links', 'Blog');">About</a></li>
            </ul>
            -->
        </nav>
    </div>
</header>



<!-- Docs page layout -->
<div class="bs-docs-header" id="content">
    <div class="container">
        <h1>Dynamic LokiJS Views And Flux Stores</h1>
        <p>Sat Mar 21 2015 16:10</p>
    </div>
</div>

<div class="container bs-docs-container">

<div class="row">
<div class="col-md-9" role="main">


<div class="alert alert-success" role="alert">Does this post need improvements? <a href="https://github.com/jrhicks/jrhicks.github.source/blob/master/pages/dynamic_loki_views_and_flux_stores/index.md">Fork it!</a></div>


<!-- h1 --><h1 class="page-header" id="md-introduction">Introduction</h1><p>There are some entertaining similarities between a LokiJS Dynamic View and a Flux Store.  In this post I introduce LokiJS Dynamic Views and demonstrate how you
could use a Flux Store to implement the same functionality.</p>
<p>I also show how to use Flux Stores to go beyond LokiJS and implement some capabilities LokiJS doesn&#39;t yet (but will soon) provide.  I end with some Flux-Frustrations that I think databases are uniquely capable of solving.</p>
<!-- h1 --><h1 class="page-header" id="md-dynamic-views">Dynamic Views</h1><p>LokiJS has a feature called dynamic views that can build themselves from a collection and then very efficiently maintain themselves from updates.  As
described on LokiJS:</p>
<blockquote>
<p>The DynamicView class allows for &#39;live&#39;, optionally persistent views. It supports multiple &#39;find&#39; and &#39;where&#39; filters and a single sort criteria. Changes to documents within the collection are automatically evaluated for addition or removal from the view ...</p>
</blockquote>
<p>Here is a bookView dynamic store:</p>
<pre><code><span class="hljs-keyword">var</span> bookView = db.books.addDynamicView(<span class="hljs-string">"OldBooks"</span>);
bookView.applyFind({<span class="hljs-string">'yearPublished'</span>:{ <span class="hljs-string">'$lt'</span> : <span class="hljs-number">1950</span> }});

<span class="hljs-comment">// Its worth noting that bookView is an event emitter.</span>
bookView.on(<span class="hljs-string">'rebuild'</span>, <span class="hljs-keyword">callback</span>);
</code></pre><!-- h1 --><h1 class="page-header" id="md-flux-stores">Flux Stores</h1><p>Could we implement this with a Flux Store?  Yes!</p>
<pre><code><span class="hljs-keyword">import</span> alt from <span class="hljs-string">'../alt'</span>;
<span class="hljs-keyword">import</span> db from <span class="hljs-string">'../lokidb'</span>;
<span class="hljs-keyword">import</span> BookCollectionActions from <span class="hljs-string">'../Stores/BookCollectionActions'</span>;

<span class="hljs-keyword">class</span> OldBookStore {

  <span class="hljs-constructor"><span class="hljs-keyword">constructor</span>() </span>{
    <span class="hljs-keyword">this</span>.bindActions(BookCollectionActions);
    <span class="hljs-keyword">this</span>.data = [];
  }

  rebuild(records) {
    <span class="hljs-keyword">this</span>.data = db.books.find( (r) =&gt; r.yearPublished &lt;<span class="hljs-number">1950</span> );
  }

  onCreate(record) {
    <span class="hljs-keyword">if</span> (record.yearPublished &lt; <span class="hljs-number">1950</span>) {
      <span class="hljs-keyword">this</span>.data.append(record);
    }
  }

  onUpdate({oldRecord, newRecord}) {
    <span class="hljs-keyword">if</span> (oldRecord.yearPublished &gt;= <span class="hljs-number">1950</span> &amp;&amp; newRecord.yearPublished &lt;= <span class="hljs-number">1950</span>) {
      <span class="hljs-keyword">this</span>.data.append(record);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (oldRecord.yearPublished &gt;= <span class="hljs-number">1950</span> &amp;&amp; newRecord.yearPublished &gt;= <span class="hljs-number">1950</span>) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (oldRecord.yearPublished &lt; <span class="hljs-number">1950</span> &amp;&amp; newReocrd.yearPublished &lt; <span class="hljs-number">1950</span>) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (oldRecord.yearPublished &lt; <span class="hljs-number">1950</span> &amp;&amp; newReocrd.yearPublished &gt;= <span class="hljs-number">1950</span>) {
      <span class="hljs-keyword">this</span>.data = <span class="hljs-keyword">this</span>.data.find( (r) r.id != newRecord.id );
      <span class="hljs-keyword">return</span>
    }
  }

  onDelete({oldRecord}) {
    <span class="hljs-keyword">if</span> (oldRecord.yearPublished &lt; <span class="hljs-number">1950</span>) {
      <span class="hljs-keyword">this</span>.data = <span class="hljs-keyword">this</span>.data.find( (r) r.id != newRecord.id );
    }
  }

}

<span class="hljs-module"><span class="hljs-keyword">module</span>.exports = alt.createStore(OldBookStore);</span>
</code></pre><!-- h1 --><h1 class="page-header" id="md-entertaining-similarities">Entertaining Similarities</h1><p>Certainly not identical, but I hope you see the analogy I&#39;m trying to make.</p>
<p><img src="lokilookalike.png" width="100%"></p>
<!-- h1 --><h1 class="page-header" id="md-lokijs-joins">LokiJS Joins</h1><p>In <a href="https://github.com/techfort/LokiJS/issues/106">issue 106</a> applyMap
function was proposed for dynamic views.  It would allow things like:</p>
<pre><code><span class="hljs-reserved">var</span> bookView = books.addDynamicView(<span class="hljs-string">'bookView'</span>);
bookView.applyMap( <span class="hljs-function"><span class="hljs-params">(b)</span> =&gt;</span> objectAssign(b, {<span class="hljs-attribute">author</span>: authorsCollection.findOne({<span class="hljs-attribute">id</span>: b.author_id})}) );
</code></pre><p>This doesn&#39;t exist in LokiJS, but we could make it in a FluxStore</p>
<pre><code><span class="hljs-keyword">import</span> alt from <span class="hljs-string">'../alt'</span>;
<span class="hljs-keyword">import</span> db from <span class="hljs-string">'../lokidb'</span>;
<span class="hljs-keyword">import</span> CollectionActions from <span class="hljs-string">'../Stores/CollectionActions'</span>;

<span class="hljs-keyword">class</span> BookJoinStore {

  <span class="hljs-constructor"><span class="hljs-keyword">constructor</span>() </span>{
    <span class="hljs-keyword">this</span>.bindActions(CollectionActions);
    <span class="hljs-keyword">this</span>.data = [];
  }

  reBuild() {
    <span class="hljs-keyword">this</span>.data = db.books.data.map( (b) =&gt; {book: b, author: db.authors.findOne({id: b.authorid}) })
  }

  onCreate({collectionName, record}) {
    <span class="hljs-keyword">if</span> (collectionName ==<span class="hljs-string">'book'</span>) {
      data.append({book: record, author: db.authors.findOne({id: record.authorId})})
    }
    <span class="hljs-keyword">if</span> (collectionName == <span class="hljs-string">'author'</span>) {
      <span class="hljs-comment">// It would be nice to do something efficient</span>
      <span class="hljs-comment">// Until then</span>
      reBuild();
    }
  }

  onUpdate({collectionName, oldRecord, newRecord}) {
    <span class="hljs-keyword">if</span> (collectionName ==<span class="hljs-string">'book'</span>) {
      <span class="hljs-comment">// It would be nice to do something efficient</span>
      <span class="hljs-comment">// Until then</span>
      reBuild();
      }
    <span class="hljs-keyword">if</span> (collectionName == <span class="hljs-string">'author'</span>) {
      <span class="hljs-comment">// It would be nice to do something efficient</span>
      <span class="hljs-comment">// Until then</span>
      reBuild();
      }
  }

  onDelete({collectionName, oldRecord}) {
    <span class="hljs-keyword">if</span> (collectionName ==<span class="hljs-string">'book'</span>) {
      <span class="hljs-comment">// It would be nice to do something efficient</span>
      <span class="hljs-comment">// Until then</span>
      reBuild();    }
    <span class="hljs-keyword">if</span> (collectionName == <span class="hljs-string">'author'</span>) {
      <span class="hljs-comment">// It would be nice to do something efficient</span>
      <span class="hljs-comment">// Until then</span>
      reBuild()
      }
  }

}

<span class="hljs-module"><span class="hljs-keyword">module</span>.exports = alt.createStore(BookJoinStore);</span>
</code></pre><!-- h1 --><h1 class="page-header" id="md-flux-frustrations">Flux Frustrations</h1><p>Lets say I have 3 pages with 2 components each that all show, filter, and convert books in different ways.</p>
<p><img src="dec.png" max-width="100%"></p>
<ul>
<li><p>Do I have a store for each component?</p>
</li>
<li><p>If I have a generic store that I can flush and reconfigure, how do I handle 2 components on the same page?</p>
</li>
<li><p>If I create a store for each component, how can I minimize un-needed updates to stores not in use by views?</p>
</li>
<li><p>Why can&#39;t I have less coupling?</p>
</li>
</ul>
<p>I love stores!  I just don&#39;t want to have to author a class for every
store that is tightly coupled to the component it serves!</p>
<!-- h1 --><h1 class="page-header" id="md-database-solutions">Database Solutions</h1><!-- h2 --><h2 id="md-decoupling">Decoupling</h2><p>What if we could create the Store from within the component?  And we could do it
in a concise, declarative fashion that other people were figuring out how to keep
performant!</p>
<p>What would that look like?  I propose you could create and start listening to the store on the component mounting, and discard the store on unmount.</p>
<pre><code class="lang-javascript">componentWillMount() {
  <span class="hljs-keyword">this</span>.bookView = db.books.addDynamicView(<span class="hljs-string">"OldBooks"</span>);
  <span class="hljs-keyword">this</span>.bookView.applyFind({<span class="hljs-string">'yearPublished'</span>:{ <span class="hljs-string">'$lt'</span> : <span class="hljs-number">1950</span> }});
  <span class="hljs-keyword">this</span>.bookView.applySimpleSort({<span class="hljs-string">'yearPublished'</span>});
  <span class="hljs-keyword">this</span>.bookView.<span class="hljs-literal">on</span>(<span class="hljs-string">'rebuild'</span>, <span class="hljs-keyword">this</span>.onChange);
}

componentWillUnMount() {
  db.books.removeDynamicView(<span class="hljs-string">"OldBooks"</span>);
}

onChange() {
  <span class="hljs-keyword">this</span>.setState(<span class="hljs-keyword">this</span>.bookView.data);
}
</code></pre>
<!-- h2 --><h2 id="md-design-constraints">Design Constraints</h2><p>Have you ever wondered what to call an action?  For example, lets
say a user double-clicks on book.  Have you ever been tempted to name an
action after the user interaction?  Like &quot;BookActions.doubleClicked(book)&quot;?  Something about naming the action after the user interaction instead of the domain change feels dirty and wrong.  If what you really want to happen when
the user double clicks the book is for it be added to your favorites list, then
maybe the action should be called BookActions.addToFavorites(book).</p>
<p>We can go a step further.  What if the only actions where create, update, and
delete?  This type of design constraint
was the subject of DHH&#39;s 2006 keynote.
In it he made a controversial but persuasive argument that if you&#39;ve modeled
 your domain correctly that everything is CRUD.</p>
<p>So in the above example the DHH way would be to:</p>
<pre><code><span class="hljs-tag">FavoritesActions</span><span class="hljs-class">.create</span>({<span class="hljs-attribute">user</span>: current_user.id, <span class="hljs-attribute">book</span>: book})
</code></pre><p>While this is quite an opinionated stance.  It certainly looks good for
ditching ActionCreators and just using our collections.</p>
<pre><code><span class="hljs-tag">db</span><span class="hljs-class">.favorites</span><span class="hljs-class">.insert</span>({<span class="hljs-attribute">user</span>: current_user.id, <span class="hljs-attribute">book</span>: book});
</code></pre><p>I&#39;m certainly not suggesting this as an unbreakable rule.  You shouldn&#39;t have to make an update in order to show a drop-down menu or transition pages.  For all
non-crud operations, just use React-Router.</p>
<!-- end -->
</div>

<div class="col-md-3">
    <div class="bs-docs-sidebar hidden-print hidden-xs hidden-sm" role="complementary">

        <ul class="nav bs-docs-sidenav">
            
            
            
            <li><a href="#md-introduction">Introduction</a></li>
            
          
            
            
          
            
            
          
            
            
            <li><a href="#md-dynamic-views">Dynamic Views</a></li>
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
            <li><a href="#md-flux-stores">Flux Stores</a></li>
            
          
            
            
          
            
            
          
            
            
            <li><a href="#md-entertaining-similarities">Entertaining Similarities</a></li>
            
          
            
            
          
            
            
          
            
            
            <li><a href="#md-lokijs-joins">LokiJS Joins</a></li>
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
            <li><a href="#md-flux-frustrations">Flux Frustrations</a></li>
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
            <li><a href="#md-database-solutions">Database Solutions</a></li>
            
          
            
            
          
          <li style="margin-left: 0.5em;"><a href="#md-decoupling">Decoupling</a></li>
          
            
            
          
            
            
          
            
            
          
            
            
          
          <li style="margin-left: 0.5em;"><a href="#md-design-constraints">Design Constraints</a></li>
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
        </ul>


    </div>
</div>
</div>
</div>

<!-- Footer
================================================== -->
<footer class="bs-docs-footer" role="contentinfo">
    <div class="container">
        <p>Generated with <a href="http://wikismith.com">Wikismith</a> - <a href="http://getbootstrap.com">Bootstrap 3</a> Theme
    </div>
</footer>

<!-- bower:js -->
<script src="/bs3/bower/js/jquery.js"></script>
<script src="/bs3/bower/js/bootstrap.js"></script>
<!-- endinject -->

<!-- inject:js -->
<script src="/bs3/js/docs.min.js"></script>
<!-- endinject -->


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    // Required: on line below, replace text in quotes with your forum shortname
    var disqus_shortname = 'jrhicks';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


</body>
</html>
