<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Wikismith">

    <title>
      Offline Flux with LokiJS
    </title>

    <!-- bower:css -->
    <link rel="stylesheet" href="/bs3/bower/css/bootstrap.css">
    <!-- endinject -->

    <!-- inject:css -->
    <link rel="stylesheet" href="/bs3/css/blog.css">
    <link rel="stylesheet" href="/bs3/css/docs.min.css">
    <link rel="stylesheet" href="/bs3/css/railscasts.css">
    <!-- endinject -->

    <!--[if lt IE 9]><script src="../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../assets/js/ie10-viewport-bug-workaround.js"></script>
    <script src="../assets/js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Favicons -->
    <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-precomposed.png">
    <link rel="icon" href="/favicon.ico">


</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

<!-- Docs master nav -->
<header class="navbar navbar-static-top bs-docs-nav" id="top" role="banner">
    <div class="container">
        <div class="navbar-header">
            <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <a href="../../../" class="navbar-brand">
              <img src="http://www.gravatar.com/avatar/91f491389b01231140190aef863408c9.png">
              &nbsp;
              jrhicks.github.io
            </a>
        </div>
        <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
            <!--
            <ul class="nav navbar-nav">
                <li>
                    <a href="/interests.html">Interest</a>
                </li>
                <li>
                    <a href="/projects">Projects</a>
                </li>
                <li>
                    <a href="/about">Speaking</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://blog.getbootstrap.com" onclick="ga('send', 'event', 'Navbar', 'Community links', 'Blog');">About</a></li>
            </ul>
            -->
        </nav>
    </div>
</header>



<!-- Docs page layout -->
<div class="bs-docs-header" id="content">
    <div class="container">
        <h1>Offline Flux with LokiJS</h1>
        <p>Data fetching and replication for Offline React Single Page Applications</p>
    </div>
</div>

<div class="container bs-docs-container">

<div class="row">
<div class="col-md-9" role="main">


<div class="alert alert-success" role="alert">Want to help improve this article? <a href="https://github.com/jrhicks/jrhicks.github.source/edit/master/pages/replicate_architecture_ideas_for_react_flux_apps/index.md">Edit it</a></div>

<p>#Introduction#</p>
<p>In <a href="/client_side_routing_notes/index.html">my last post</a>, navigating <strong>data space</strong> was proposed as one of a few concerns of client side routing and the following architectures were investigated:</p>
<ul>
<li><p>Dan Abramov&#39;s <a href="/client_side_routing_notes/index.html#md-content-stores">Content Stores Pattern</a></p>
</li>
<li><p>Facebook&#39;s <a href="/client_side_routing_notes/index.html#md-relay-and-graphql">Relay Architecture</a></p>
</li>
<li><p>A Home Brewed <a href="/client_side_routing_notes/index.html#md-offline-partitions-store">Offline Partitions Store</a></p>
</li>
</ul>
<p>In this article I recap these patterns quickly and introduce how an offline flux pattern and example project that draws on qualities of each of these.</p>
<p>#Content Stores Pattern#</p>
<p><img src="flux.png" width="100%"></p>
<p><strong>Dan Abramov&#39;s <a href="/client_side_routing_notes/index.html#md-content-stores">Content Stores</a> approach is pure flux!</strong>  We have a content store for each entity type.  Server actions dispatch to all stores, the stores inspect the response and harvest any data that pertains to them.  The views listen to stores and render as needed.</p>
<p>#Relay Architecture#</p>
<p><strong>Facebook&#39;s Relay approach is pure decoupling!</strong>  Statically declare the data needs of a component within itself.  Eliminate creating and <em>maintaining</em> custom server end-points that match the needs of each component (and subcomponent) on the page.</p>
<p><img src="relay3.png" width="100%"></p>
<p>#Offline Flux</p>
<p>I liked the pure flux of Dan&#39;s approach and the pure decoupling of Relay.  How could I combine  these ideas, into an architecture that featured a replicating database that could be used offline.</p>
<p><img src="offline_flux.png" width="100%"></p>
<p>##Replicate</p>
<p>In the diagram above, you might find Replicate to be placed oddly as a sibling of view.  You can consider Replicate as a background worker that initiates actions routinely.  Replicate listens to stores similarly to components, but instead of updating DOM it changes aspects of
replication.</p>
<p>ReplicateStore tells Replicate:</p>
<ul>
<li><p>What to Replicate</p>
</li>
<li><p>How frequently</p>
</li>
<li><p>Paging &amp; Cursor Management</p>
</li>
</ul>
<pre><code class="lang-js"><span class="hljs-keyword">class</span> Replicate {

  <span class="hljs-comment">// Replicate (Like A Component) Listens to Stores</span>
  <span class="hljs-constructor"><span class="hljs-keyword">constructor</span>() </span>{
    ReplicateStore.listen(<span class="hljs-keyword">this</span>.onReplicationChange);
    <span class="hljs-keyword">this</span>.state = ReplicateStore.getState();
  }

  onReplicationChange() {
    <span class="hljs-keyword">this</span>.state = ReplicateStore.getState();
  }

  <span class="hljs-comment">// Replicate Is Worker That Continuously Runs</span>
  async run() {
    <span class="hljs-keyword">let</span> resolution = <span class="hljs-number">50</span>;
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.state.shouldReplicate) {
        await <span class="hljs-keyword">this</span>.createReplicateAction();
      }
      await <span class="hljs-keyword">this</span>.milliseconds(resolution);
    }
  }

  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>It works out nicely for replication duties and behavior to be governed by stores because the replicate worker and views can respond equally.</p>
<p>##DB</p>
<p>You will also notice a DB inside of Store.  This illustrates that access to the
DB is mediated through the store.  When Replicate receives a page of data from
the server it sends a queue action to the ReplicateStore.  ReplicateStore appends
the data to its queue and loads it in 20 microsecond intervals.  <a href="http://lokijs.org/">LokiJS</a> can knock out well over
1000 in this time.  Similarly; basic insert, save, and delete operations are
mediated through the store.</p>
<p>##Similarities to Content Stores##</p>
<p>Much like Content Stores, data is stored normalized and the Flux pattern is respected.  Unlike Content Stores, the different entities are not separated
into their own stores.  Data is segregated into collections (LokiJS&#39;s concept
of a table).  Having all collections in one store keeps things real easy, but it might seem at the cost of components over-responding to changes from collections they don&#39;t care about.  However, if components check collection&#39;s updatedAt in shouldComponentUpdate they can remain lazy.</p>
<p>##Similarities to Relay##</p>
<p>Similar to Relay, the components control what data is fetched!  In this example we get the projectId from the router and tell the replicated database to include the notes and contacts for this project.</p>
<pre><code>componentWillMount() {
  let projectId = parseInt(<span class="hljs-keyword">this</span>.getParams().projectId);
  ReplicateActions.subscribe(<span class="hljs-string">'note'</span>, {<span class="hljs-string">project_id:</span> projectId} );
  ReplicateActions.subscribe(<span class="hljs-string">'contact'</span>, {<span class="hljs-string">project_id:</span> projectId} );
},
</code></pre><p>Similar to Relay, your server can have one generic server end point!  Which is awesome!  But you don&#39;t need GQL magic on the server, <a href="https://github.com/jrhicks/LokiJS-Flux-Example/blob/master/app/controllers/offline_controller.rb">here is a basic implementation in Rails</a></p>
<p>##Performance##</p>
<p>Its fast!   Thanks React and Loki!  In this video, I sync (download and insert into an offline database) over 10,000 records.  I&#39;m using Flux to manage the replication
process and update the React view component to display progress.</p>
<p>While I&#39;m pretty happy with 11,000 records in 4 seconds, I&#39;m pretty sure I could
make it a lot faster if I didn&#39;t wait until it was done loading each batch before
I requested the next batch from the server.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/W7htuT9ZJck" frameborder="0" allowfullscreen></iframe>

<p>##Example Repository##</p>
<p>You can checkout the full project here <a href="https://github.com/jrhicks/LokiJS-Flux-Example">https://github.com/jrhicks/LokiJS-Flux-Example</a></p>
<p>git clone <a href="https://github.com/jrhicks/LokiJS-Flux-Example.git">https://github.com/jrhicks/LokiJS-Flux-Example.git</a></p>
<p>cd LokiJS-Flux-Example</p>
<p>bundle install</p>
<p>rake db:setup</p>
<p>npm install</p>
<p>foreman start</p>
<p>open <a href="http://localhost:3000">http://localhost:3000</a></p>
<!-- end -->
<hr>

<a href="https://twitter.com/share" class="twitter-share-button" data-via="jrhicks">Tweet</a>

<a href="https://twitter.com/jrhicks">Follow Jeffrey Hicks on Twitter</a></a>
<hr>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'jrhicksgithubio';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


</div>

<div class="col-md-3">
    <div class="bs-docs-sidebar hidden-print hidden-xs hidden-sm" role="complementary">

        <ul class="nav bs-docs-sidenav">
            
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
        </ul>


    </div>
</div>
</div>
</div>

<!-- Footer
================================================== -->
<footer class="bs-docs-footer" role="contentinfo">
    <div class="container">
        <p>Generated with <a href="http://wikismith.com">Wikismith</a> - <a href="http://getbootstrap.com">Bootstrap 3</a> Theme
    </div>
</footer>

<!-- bower:js -->
<script src="/bs3/bower/js/jquery.js"></script>
<script src="/bs3/bower/js/bootstrap.js"></script>
<!-- endinject -->

<!-- inject:js -->
<script src="/bs3/js/docs.min.js"></script>
<!-- endinject -->


<!-- TWITTER Put this just before the closing body tag -->
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</body>
</html>
